apiVersion: batch/v1
kind: CronJob
metadata:
  name: fred-bulk-collector-weekly
  namespace: gzc-analytics
spec:
  # Run every Sunday at 2am EST (6am UTC)
  schedule: "0 6 * * 0"
  timezone: "America/New_York"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  concurrencyPolicy: Forbid  # Don't run multiple bulk collections at once
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600  # Keep for 1 hour after completion
      backoffLimit: 1  # Only retry once
      template:
        spec:
          nodeSelector:
            workload: bulk-collection
          tolerations:
          - key: workload
            operator: Equal
            value: bulk-collection
            effect: NoSchedule
          containers:
          - name: bulk-collector
            image: gzcacr.azurecr.io/fred-bulk-collector:v10-k8s-fix
            imagePullPolicy: Always
            envFrom:
            - secretRef:
                name: fred-api-keys-all
            env:
            - name: MAX_CONCURRENT
              value: "2"
            resources:
              requests:
                memory: "32Gi"
                cpu: "2000m"
              limits:
                memory: "128Gi"
                cpu: "16000m"
          restartPolicy: Never
