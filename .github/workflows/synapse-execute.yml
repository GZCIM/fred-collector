name: Execute Synapse Blob-to-Delta Transformation

on:
  workflow_dispatch:
    inputs:
      vintage_date:
        description: 'Vintage date (YYYY-MM-DD)'
        required: true
        default: '2025-11-21'
      release_id:
        description: 'Release ID (leave empty for all releases)'
        required: false
        default: ''

jobs:
  execute-transformation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Trigger Synapse Pipeline Execution
        run: |
          echo "=================================="
          echo "SYNAPSE PIPELINE EXECUTION"
          echo "=================================="
          echo "Workspace: externaldata"
          echo "Pipeline: blob_to_delta_pipeline"
          echo "Notebook: blob_to_delta_transformer"
          echo "Vintage Date: ${{ github.event.inputs.vintage_date }}"
          echo "Release ID: ${{ github.event.inputs.release_id || '(all)' }}"
          echo ""
          echo "Getting Azure access token..."

          # Get access token for Synapse REST API
          TOKEN=$(az account get-access-token --resource=https://dev.azuresynapse.net --query accessToken -o tsv)

          # Build parameters JSON for pipeline
          PARAMS=$(cat <<EOF
          {
            "storage_account": "gzcstorageaccount",
            "container": "macroeconomic-maintained-series",
            "vintage_date": "${{ github.event.inputs.vintage_date }}",
            "release_id": "${{ github.event.inputs.release_id }}"
          }
          EOF
          )

          # Trigger pipeline execution via REST API
          RUN_RESPONSE=$(curl -X POST \
            "https://externaldata.dev.azuresynapse.net/pipelines/blob_to_delta_pipeline/createRun?api-version=2020-12-01" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"parameters\": $PARAMS}")

          echo "Response: $RUN_RESPONSE"

          # Extract run ID
          RUN_ID=$(echo $RUN_RESPONSE | jq -r '.runId // .id // empty')

          if [ -n "$RUN_ID" ] && [ "$RUN_ID" != "null" ]; then
            echo ""
            echo "✅ Pipeline execution started successfully"
            echo "Run ID: $RUN_ID"
            echo ""
            echo "Monitor execution at:"
            echo "https://web.azuresynapse.net/monitoring/pipelineruns"
          else
            echo "❌ Failed to start pipeline execution"
            echo "Full response: $RUN_RESPONSE"
            exit 1
          fi

      - name: Monitor Execution (Optional)
        if: success()
        run: |
          echo ""
          echo "=================================="
          echo "EXECUTION MONITORING"
          echo "=================================="
          echo "The transformation is now running in Azure Synapse."
          echo ""
          echo "Expected Duration: 10-15 minutes"
          echo "Expected Outputs:"
          echo "  - Delta Lake: US_Fred_Data/series_observations"
          echo "  - Analysis: US_Fred_Data/analysis/"
          echo ""
          echo "Monitor progress at:"
          echo "https://web.azuresynapse.net/monitoring/sparkapplication"
